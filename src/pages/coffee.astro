---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from 'astro:content';
import { siteConfig } from "../config";

const headProps = {
  title: `Coffee · ${siteConfig.name}`,
  description: "Coffee reviews, visits, and rankings",
  link: `${import.meta.env.SITE}/coffee`
};

const allPosts = await getCollection('coffee-posts');
const sortedPosts = allPosts.sort((a: CollectionEntry<'coffee-posts'>, b: CollectionEntry<'coffee-posts'>) => 
  b.data.date.getTime() - a.data.date.getTime()
);
---

<BaseLayout headProps={headProps}>
	<article class="coffee-page">
		<header class="page-header">
			<div class="header-top">
				<a href="/" class="back-link">← Back</a>
				<a href="/coffee/leaderboard" class="leaderboard-link">Leaderboard →</a>
			</div>
			<h1>Coffee</h1>
			<p class="subtitle">Reviews and visits</p>
		</header>

		<div class="feed-section">
			{sortedPosts.length > 0 ? (
				<div class="feed-list">
					{sortedPosts.map((post: CollectionEntry<'coffee-posts'>) => (
						<article class="feed-item">
							<a href={`/coffee/${post.slug}`} class="feed-link">
								<div class="feed-header">
									<h3 class="feed-title">{post.data.title}</h3>
									<div class="feed-meta">
										<span class="shop-name">{post.data.shopName}</span>
										<span class="separator">·</span>
										<span class="location">{post.data.location}</span>
									</div>
								</div>
								<div class="feed-footer">
									<div class="rating">
										{Array.from({ length: 5 }, (_, i) => (
											<span class={`star ${i < post.data.rating ? 'filled' : 'empty'}`}>
												{i < post.data.rating ? '★' : '☆'}
											</span>
										))}
										<span class="rating-value">{post.data.rating.toFixed(1)}</span>
									</div>
									<time class="date">
										{post.data.date.toLocaleDateString('en-US', { 
											year: 'numeric', 
											month: 'short', 
											day: 'numeric' 
										})}
									</time>
								</div>
								{post.data.excerpt && (
									<p class="excerpt">{post.data.excerpt}</p>
								)}
							</a>
						</article>
					))}
				</div>
			) : (
				<p class="no-posts">No posts yet. Check back soon!</p>
			)}
		</div>
	</article>
</BaseLayout>

<style>
	.coffee-page {
		width: 100%;
		max-width: 42em;
		margin: 0 auto;
		display: flex;
		flex-direction: column;
		gap: 2em;
	}

	.page-header {
		display: flex;
		flex-direction: column;
		gap: 0.6em;
		margin-bottom: 1em;
	}

	.header-top {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.leaderboard-link {
		font-size: 0.9em;
		color: var(--theme-sub-text);
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.leaderboard-link:hover {
		color: var(--theme-accent);
		background: none;
	}

	.feed-section {
		width: 100%;
	}

	h1 {
		font-size: 1.8em;
		font-weight: 500;
		margin: 0;
		color: var(--theme-text);
	}

	.subtitle {
		color: var(--theme-sub-text);
		font-size: 0.95em;
		margin: 0;
		line-height: 1.6;
	}

	/* Feed Styles */
	.feed-list {
		display: flex;
		flex-direction: column;
		gap: 1.5em;
	}

	.feed-item {
		padding: 1.5em 0;
		border-bottom: 1px solid var(--theme-sub-text);
		border-bottom-opacity: 0.15;
	}

	.feed-item:last-child {
		border-bottom: none;
	}

	.feed-link {
		text-decoration: none;
		color: inherit;
		display: flex;
		flex-direction: column;
		gap: 0.7em;
	}

	.feed-link:hover {
		background: none;
		color: inherit;
	}

	.feed-header {
		display: flex;
		flex-direction: column;
		gap: 0.3em;
	}

	.feed-title {
		font-size: 1.1em;
		font-weight: 500;
		margin: 0;
		color: var(--theme-text);
		transition: color 0.2s ease;
	}

	.feed-item:hover .feed-title {
		color: var(--theme-accent);
	}

	.feed-meta {
		display: flex;
		align-items: center;
		gap: 0.5em;
		font-size: 0.85em;
		color: var(--theme-sub-text);
	}

	.shop-name {
		font-weight: 500;
	}

	.separator {
		opacity: 0.5;
	}

	.feed-footer {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 1em;
	}

	.rating {
		display: flex;
		align-items: center;
		gap: 0.4em;
	}

	.star {
		color: var(--theme-sub-text);
		font-size: 0.9em;
	}

	.star.filled {
		color: var(--theme-accent);
	}

	.rating-value {
		font-size: 0.85em;
		color: var(--theme-sub-text);
		margin-left: 0.2em;
		font-variant-numeric: tabular-nums;
	}

	.date {
		font-size: 0.85em;
		color: var(--theme-sub-text);
		font-variant-numeric: tabular-nums;
	}

	.excerpt {
		font-size: 0.9em;
		color: var(--theme-text);
		opacity: 0.8;
		margin: 0;
		line-height: 1.6;
	}

	.no-posts {
		text-align: center;
		color: var(--theme-sub-text);
		padding: 2em 0;
		font-size: 0.95em;
	}

	@media (max-width: 768px) {
		h1 {
			font-size: 1.5em;
		}

		.feed-item {
			padding: 1.2em 0;
		}

		.feed-title {
			font-size: 1em;
		}

		.feed-footer {
			flex-direction: column;
			align-items: flex-start;
			gap: 0.5em;
		}
	}
</style>

